<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BOI – Mumbai Branch Location Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --vh: 1vh;
}

html, body {
  margin: 0;
  padding: 0;
  height: calc(var(--vh) * 100);
  font-family: Arial, sans-serif;
  overflow: hidden;
}

/* HEADER */
header {
  height: 52px;
  background: #263238;
  color: #fff;
  display: flex;
  align-items: center;
  padding: 0 16px;
  font-size: 18px;
}

/* TOP BAR */
#topbar {
  height: 52px;
  background: #f1f3f4;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 10px;
}

#menuBtn {
  padding: 8px 12px;
  font-size: 14px;
}

#search {
  flex: 1;
  padding: 8px;
  font-size: 14px;
}

/* MAP */
#map {
  position: absolute;
  top: 104px;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
}

/* SIDEBAR */
#sidebar {
  position: fixed;
  top: 0;
  left: -300px;
  width: 300px;
  height: 100%;
  background: #ffffff;
  z-index: 1000;
  box-shadow: 4px 0 10px rgba(0,0,0,0.3);
  transition: left 0.3s ease;
  overflow-y: auto;
}

#sidebar.open {
  left: 0;
}

#sidebar h3 {
  margin: 0;
  padding: 16px;
  background: #263238;
  color: #fff;
}

/* BRANCH ITEM */
.branch {
  padding: 10px 14px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.branch:hover {
  background: #e0f2f1;
}

/* OVERLAY */
#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: none;
  z-index: 900;
}

#overlay.show {
  display: block;
}
</style>
</head>

<body>

<header>BOI – Mumbai Branch Location Map</header>

<div id="topbar">
  <button id="menuBtn">☰ Branches</button>
  <input id="search" placeholder="Search branch name">
</div>

<div id="map"></div>

<div id="overlay"></div>

<div id="sidebar">
  <h3>Branch List</h3>
  <div id="branchList"></div>
</div>

<script>
/* ---------- FIX MOBILE VIEWPORT HEIGHT ---------- */
function setVH() {
  document.documentElement.style.setProperty(
    '--vh',
    window.innerHeight * 0.01 + 'px'
  );
}
setVH();
window.addEventListener('resize', setVH);

/* ---------- MAP INIT ---------- */
const map = L.map("map").setView([19.076, 72.8777], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let markers = [];

/* ---------- SIDEBAR ---------- */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");

function openSidebar() {
  sidebar.classList.add("open");
  overlay.classList.add("show");
}

function closeSidebar() {
  sidebar.classList.remove("open");
  overlay.classList.remove("show");
  setTimeout(() => map.invalidateSize(true), 300);
}

document.getElementById("menuBtn").onclick = openSidebar;
overlay.onclick = closeSidebar;

/* ---------- LOAD EXCEL ---------- */
fetch("./branches.xlsx")
  .then(r => r.arrayBuffer())
  .then(data => {
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    plot(rows);
  });

function plot(rows) {
  const list = document.getElementById("branchList");
  const bounds = L.latLngBounds();
  list.innerHTML = "";

  rows.forEach(r => {
    const name = String(r.BranchName).trim();
    const lat = parseFloat(String(r.Latitude).trim());
    const lng = parseFloat(String(r.Longitude).trim());

    if (!name || isNaN(lat) || isNaN(lng)) return;

    const marker = L.marker([lat, lng]).addTo(map)
      .bindPopup(`<b>${name}</b>`);

    marker.branchName = name.toLowerCase();
    markers.push(marker);
    bounds.extend([lat, lng]);

    const div = document.createElement("div");
    div.className = "branch";
    div.textContent = name;

    div.onclick = () => {
      map.setView([lat, lng], 15);
      marker.openPopup();
      closeSidebar();
    };

    list.appendChild(div);
  });

  map.fitBounds(bounds);
}

/* ---------- SEARCH ---------- */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase().trim();
  if (!q) return;

  const match = markers.find(m => m.branchName.includes(q));
  if (match) {
    map.setView(match.getLatLng(), 15);
    match.openPopup();
    closeSidebar();
  }
});
</script>

</body>
</html>