<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BOI Mumbai Branch Locator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}

header {
  background: #263238;
  color: #fff;
  padding: 10px 16px;
}

#controls {
  padding: 8px 12px;
  background: #f4f4f4;
  border-bottom: 1px solid #ddd;
  display: flex;
  align-items: center;
  gap: 10px;
}

#search {
  padding: 6px;
  width: 260px;
}

#toggleBtn {
  padding: 6px 10px;
  cursor: pointer;
}

#container {
  display: flex;
  height: calc(100vh - 110px);
}

#sidebar {
  width: 300px;
  background: #fafafa;
  border-right: 1px solid #ddd;
  overflow-y: auto;
  transition: transform 0.3s ease;
}

#sidebar.hidden {
  transform: translateX(-300px);
}

#map {
  flex: 1;
}

.branch-item {
  padding: 8px 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.branch-item:hover {
  background: #e0f2f1;
}
</style>
</head>

<body>

<header>
  <h3>BOI – Mumbai Branch Location Map</h3>
</header>

<div id="controls">
  <button id="toggleBtn">☰ Branches</button>
  <input id="search" placeholder="Search branch name (zoom only)">
</div>

<div id="container">
  <div id="sidebar">
    <div id="branchList"></div>
  </div>
  <div id="map"></div>
</div>

<script>
let map;
let markers = [];
let bounds;

const sidebar = document.getElementById("sidebar");

/* ---------- MAP INIT ---------- */
map = L.map("map").setView([19.076, 72.8777], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* ---------- LOAD EXCEL ---------- */
fetch("./branches.xlsx")
  .then(r => r.arrayBuffer())
  .then(data => {
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    console.log("Rows in Excel:", rows.length);
    plotBranches(rows);
  });

/* ---------- PLOT ---------- */
function plotBranches(rows) {
  bounds = L.latLngBounds();
  document.getElementById("branchList").innerHTML = "";

  rows.forEach(row => {
    const name = String(row.BranchName || "").trim();
    const lat = parseFloat(String(row.Latitude).trim());
    const lng = parseFloat(String(row.Longitude).trim());

    if (!name || isNaN(lat) || isNaN(lng)) return;

    const marker = L.marker([lat, lng])
      .addTo(map)
      .bindPopup(`<b>${name}</b>`);

    marker.branchName = name.toLowerCase();
    markers.push(marker);
    bounds.extend([lat, lng]);

    const div = document.createElement("div");
    div.className = "branch-item";
    div.textContent = name;

    div.onclick = () => {
      map.setView(marker.getLatLng(), 15);
      marker.openPopup();
      hideSidebar();
    };

    document.getElementById("branchList").appendChild(div);
  });

  map.fitBounds(bounds);
  console.log("Markers loaded:", markers.length);
}

/* ---------- SEARCH ---------- */
document.getElementById("search").addEventListener("input", function () {
  const q = this.value.toLowerCase().trim();
  if (!q) return;

  const match = markers.find(m => m.branchName.includes(q));
  if (match) {
    map.setView(match.getLatLng(), 15);
    match.openPopup();
    hideSidebar();
  }
});

/* ---------- SIDEBAR TOGGLE ---------- */
function hideSidebar() {
  sidebar.classList.add("hidden");
  setTimeout(() => map.invalidateSize(), 350);
}

document.getElementById("toggleBtn").onclick = () => {
  sidebar.classList.toggle("hidden");
  setTimeout(() => map.invalidateSize(), 350);
};
</script>

</body>
</html>